<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sunny's Cascade Buster</title>

<style>
:root {
  --bg: #1b1b1b;
  --panel: #242424;
  --panel-soft: #2b2b2b;
  --border: #3a3a3a;
  --text: #e4e4e4;
  --muted: #a8a8a8;
  --accent: #8fb3ff;
}

body {
  margin: 0;
  font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
  background: var(--bg);
  color: var(--text);
}

.page {
  display: flex;
  gap: 36px;
  padding: 32px;
  align-items: flex-start;
}

.main {
  flex: 1;
  max-width: 980px;
}

.sidebar img {
  max-width: 320px;
  height: auto;
  display: block;
  opacity: 0.95;
}

h1 {
  font-size: 2rem;
  font-weight: 600;
  margin: 0 0 16px 0;
}

.info-box {
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  padding: 14px 16px;
  font-size: 0.85rem;
  line-height: 1.5;
  color: var(--muted);
  margin-bottom: 28px;
}

h2 {
  font-size: 0.95rem;
  margin: 26px 0 8px 0;
  font-weight: 500;
  color: var(--muted);
  text-transform: uppercase;
  letter-spacing: 0.06em;
}

textarea {
  width: 100%;
  height: 180px;
  padding: 14px;
  font-family: ui-monospace, SFMono-Regular, Consolas, monospace;
  font-size: 0.9rem;
  line-height: 1.5;
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 8px;
  resize: vertical;
}

textarea[readonly] {
  background: #202020;
  color: var(--muted);
}

textarea:focus {
  outline: none;
  border-color: var(--accent);
}

button {
  margin-top: 10px;
  padding: 8px 16px;
  font-size: 0.8rem;
  background: var(--panel-soft);
  color: var(--text);
  border: 1px solid var(--border);
  border-radius: 999px;
  cursor: pointer;
}

button:hover {
  background: #3a3a3a;
}

pre {
  margin-top: 14px;
  padding: 16px;
  background: var(--panel);
  border: 1px solid var(--border);
  border-radius: 8px;
  white-space: pre-wrap;
  font-family: ui-monospace, SFMono-Regular, Consolas, monospace;
  font-size: 0.85rem;
  line-height: 1.5;
}

@media (max-width: 768px) {
  .page {
    flex-direction: column;
  }

  .sidebar {
    display: flex;
    justify-content: center;
    margin-top: 28px;
  }

  .sidebar img {
    max-width: 240px;
  }
}
</style>
</head>

<body>
<div class="page">

  <div class="main">
    <h1>Sunnyâ€™s Cascade Buster c:</h1>

    <div class="info-box">
      This tool is for stopping cascade in <em>specific</em> entries. It will find the triggers in the text you provide and then wrap them.<br><br>
      - export your completed dreamjourney lorebook json<br>
      - paste it in box and hit extract triggers<br>
      - the list will populate<br>
      - paste whatever body text you want to wrap<br>
      - hit wrap triggers!
    </div>

    <h2>Paste Lorebook JSON</h2>
    <textarea id="jsonInput"></textarea>
    <button onclick="extractTriggers()">Extract Triggers</button>

    <h2>Extracted Triggers (Audit)</h2>
    <textarea id="triggerList" readonly></textarea>

    <h2>Paste Text to Process</h2>
    <textarea id="textInput"></textarea>
    <button onclick="wrapTriggers()">Wrap Triggers</button>

    <h2>Output</h2>
    <pre id="output"></pre>
    <button onclick="copyOutput()">Copy Output</button>
  </div>

  <div class="sidebar">
    <img src="https://i.imgur.com/yeSYFNZ.png" alt="Sunflower seeds artwork">
  </div>

</div>

<script>
let triggers = [];

function extractTriggers() {
  triggers = [];
  document.getElementById("triggerList").value = "";

  try {
    const data = JSON.parse(document.getElementById("jsonInput").value);

    if (!Array.isArray(data.entries)) {
      alert("No entries array found.");
      return;
    }

    data.entries.forEach(entry => {
      if (!Array.isArray(entry.keys)) return;

      entry.keys.forEach(k => {
        if (typeof k.keyText === "string" && k.keyText.trim()) {
          triggers.push(k.keyText);
        }
      });
    });

    triggers.sort((a, b) => b.length - a.length);

    document.getElementById("triggerList").value = triggers.join("\n");
    alert("Extracted " + triggers.length + " triggers.");

  } catch {
    alert("Invalid JSON.");
  }
}

function wrapTriggers() {
  let text = document.getElementById("textInput").value;

  triggers.forEach(trigger => {
    const escaped = trigger.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");

    const regex = new RegExp(
      `(?<![A-Za-z0-9])${escaped}(?![A-Za-z0-9])`,
      "gi"
    );

    text = text.replace(regex, match => {
      return "_" + match.replace(/\s+/g, "_") + "_";
    });
  });

  document.getElementById("output").textContent = text;
}

function copyOutput() {
  const output = document.getElementById("output").textContent;
  if (!output.trim()) return;
  navigator.clipboard.writeText(output);
}
</script>

</body>
</html>
