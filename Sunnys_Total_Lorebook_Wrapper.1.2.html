<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Sunny's Total Lorebook Cascade Destroyer</title>

<style>
  body {
    background: #2b2b2b;
    color: #eaeaea;
    font-family: system-ui, sans-serif;
    margin: 0;
  }

  .page {
    display: flex;
    gap: 36px;
    padding: 20px;
    align-items: flex-start;
  }

  .main {
    flex: 1;
  }

  .sidebar img {
    max-width: 320px;
    height: auto;
    display: block;
    opacity: 0.95;
  }

  h1 {
    font-size: 1.8rem;
    margin-bottom: 12px;
    font-weight: 600;
  }

  .info-box {
    background: #1e1e1e;
    border: 1px solid #444;
    padding: 12px 14px;
    margin-bottom: 18px;
    font-size: 0.85rem;
    line-height: 1.5;
    color: #cfcfcf;
  }

  .label {
    margin: 12px 0 4px;
    font-weight: 600;
  }

  textarea {
    width: 100%;
    height: 220px;
    background: #1e1e1e;
    color: #eaeaea;
    border: 1px solid #444;
    padding: 10px;
    box-sizing: border-box;
    font-family: monospace;
    margin-bottom: 12px;
  }

  .triggers {
    background: #1e1e1e;
    border: 1px solid #444;
    padding: 10px;
    margin-bottom: 12px;
    max-height: 160px;
    overflow-y: auto;
    font-family: monospace;
    white-space: pre-wrap;
  }

  button {
    padding: 8px 14px;
    background: #444;
    color: #eaeaea;
    border: 1px solid #666;
    cursor: pointer;
    margin-right: 8px;
  }

  button:hover {
    background: #555;
  }

  @media (max-width: 768px) {
    .page {
      flex-direction: column;
    }

    .sidebar {
      display: flex;
      justify-content: center;
      margin-top: 28px;
    }

    .sidebar img {
      max-width: 240px;
    }
  }
</style>
</head>

<body>

<div class="page">

  <div class="main">

    <h1>Sunnyâ€™s Total Lorebook Cascade Destroyer</h1>

    <div class="info-box">
      - This will identify all the triggers in your lorebook and wrap ALL the triggers present in the body text<br>
      - This allows you to use the trigger words without triggering other entries<br>
      - This will remove all "references" from the lorebook<br>
      - If you want to <em>keep some references</em> you will have to wait and see if I can figure out how to do that :D<br>
      - Export your completed lorebook json to clipboard, paste it here, hit wrap, boom!
    </div>

    <div class="label">Input Lorebook JSON</div>
    <textarea id="input"></textarea>

    <button onclick="process()">Wrap Triggers</button>

    <div class="label">Detected Triggers</div>
    <div id="triggerList" class="triggers"></div>

    <div class="label">Output JSON</div>
    <textarea id="output"></textarea>

    <button onclick="copyOutput()">Copy Output</button>

  </div>

  <div class="sidebar">
    <img src="https://i.imgur.com/yeSYFNZ.png" alt="Sunflower seeds artwork">
  </div>

</div>

<script>
function escapeRegex(str) {
  return str.replace(/[.*+?^${}()|[\]\\]/g, "\\$&");
}

function buildRegex(trigger) {
  const escaped = escapeRegex(trigger);
  return new RegExp(
    `(?<![A-Za-z])(${escaped})(?![A-Za-z])`,
    "gi"
  );
}

function process() {
  let data;

  try {
    data = JSON.parse(document.getElementById("input").value);
  } catch {
    alert("Invalid JSON");
    return;
  }

  if (!Array.isArray(data.entries)) {
    alert("Invalid lorebook format");
    return;
  }

  const triggers = [];

  data.entries.forEach(entry => {
    if (Array.isArray(entry.keys)) {
      entry.keys.forEach(k => {
        if (typeof k.keyText === "string") {
          triggers.push(k.keyText);
        }
      });
    }
  });

  triggers.sort((a, b) => b.length - a.length);

  document.getElementById("triggerList").textContent =
    triggers.length ? triggers.join("\n") : "(none)";

  data.entries.forEach(entry => {
    if (typeof entry.description !== "string") return;

    let text = entry.description;

    triggers.forEach(trigger => {
      const regex = buildRegex(trigger);
      text = text.replace(regex, "_$1_");
    });

    entry.description = text;
  });

  document.getElementById("output").value =
    JSON.stringify(data, null, 2);
}

function copyOutput() {
  const out = document.getElementById("output");
  out.select();
  document.execCommand("copy");
}
</script>

</body>
</html>
